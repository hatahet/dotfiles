#!/bin/sh

iptables=/sbin/iptables
iptcmd="sudo $iptables"
ssh='autossh'

[ $# -ge 1 ] || exit 1
[ -x $iptables ] || exit 2
[ -x `which $ssh` ] || ssh='ssh'
[ -x `which $ssh` ] || exit 3

host=$1
port=$2
[ -z $port ] && port=22
ip=`dig +short "$host" a |egrep -v [A-Za-z]`

testport() {
    echo hi | nc 127.0.0.1 1080
    status=$?
    if [ $status -ne 0 ]
    then
        echo -n .
        sleep 1
        testport
    fi
}

[ -d $HOME/tmp ] || mkdir $HOME/tmp
echo -n Connecting to $host
$ssh -N -f -p $port -D 1080 $host
testport
echo Done.
PID=`pidof -s $ssh`
[ ! -z $PID ] && echo $PID >$HOME/tmp/autossh.pid

set -x
$iptcmd -F
$iptcmd -P INPUT DROP
$iptcmd -A INPUT -i lo+ -j ACCEPT
$iptcmd -A OUTPUT -o lo+ -j ACCEPT
$iptcmd -A INPUT -s $ip -p tcp --sport $port -j ACCEPT
$iptcmd -A OUTPUT -d $ip -p tcp --dport $port -j ACCEPT
$iptcmd -A OUTPUT -j REJECT
