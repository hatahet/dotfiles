#!/bin/sh

iptables=/sbin/iptables
iptcmd="sudo $iptables"
ssh='autossh'

[ $# -ge 1 ] || exit 1
[ -x $iptables ] || exit 2
[ -x `which $ssh` ] || ssh='ssh'
[ -x `which $ssh` ] || exit 3

proxyoff=$HOME/bin/proxyoff
echo "#!/bin/sh" >$proxyoff
echo "$iptcmd -F" >>$proxyoff
$iptcmd -S | sed "s=^=$iptcmd =" >>$proxyoff

host=$1
port=$2
[ -z $port ] && port=22
ip=`dig +short "$host" a |egrep -v [A-Za-z]`

testport() {
    echo hi | nc 127.0.0.1 1080
    status=$?
    if [ $status -ne 0 ]
    then
        echo -n .
        sleep 1
        testport
    fi
}

echo -n Connecting to $host:$port
$ssh -N -f -p $port -D 1080 $ip
testport
PID=`pidof -s $ssh`
echo Done: $PID.
echo "kill $PID" >>$proxyoff
echo "rm $proxyoff" >>$proxyoff

set -x
$iptcmd -F
$iptcmd -P INPUT DROP
$iptcmd -P OUTPUT DROP
$iptcmd -A INPUT -i lo+ -j ACCEPT
$iptcmd -A OUTPUT -o lo+ -j ACCEPT
$iptcmd -A INPUT -s $ip -p tcp --sport $port -j ACCEPT
$iptcmd -A OUTPUT -d $ip -p tcp --dport $port -j ACCEPT
chmod +x $proxyoff
